<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Админ-панель</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #007bff;
            --tg-theme-button-color: #007bff;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f8f9fa;
        }
        body { padding: 10px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); font-size: 14px; padding-top: 65px; } /* Added padding-top */
        .nav-link { color: var(--tg-theme-link-color); padding: 0.5rem 0.8rem; font-size: 0.9rem; }
        .nav-link.active { color: var(--tg-theme-text-color); background-color: var(--tg-theme-secondary-bg-color); }
        .form-control, .form-select { background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); border-color: var(--tg-theme-hint-color); font-size: 0.9rem; }
        .form-control::placeholder { color: var(--tg-theme-hint-color); }
        .btn { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; font-size: 0.9rem; }
        .btn-secondary { background-color: #6c757d; }
        .btn-success { background-color: #198754; }
        .btn-danger { background-color: #dc3545; }
        .btn-warning { background-color: #ffc107; color: #000;}
        .btn-sm { padding: 0.2rem 0.4rem; font-size: 0.8rem; }
        .list-group-item { background-color: var(--tg-theme-secondary-bg-color); border-color: var(--tg-theme-hint-color); padding: 0.75rem; }
        .loading { text-align: center; padding: 15px; color: var(--tg-theme-hint-color); }
        .form-label { margin-bottom: 0.3rem; font-weight: bold;}
        .student-attendance-row span { margin-right: 10px; }
        .statistic-item { margin-bottom: 5px; }
        .nav-pills { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 5px;}
        .nav-pills .nav-link { white-space: nowrap; }
        .tab-pane { padding-top: 10px;}
        #groupSelectorContainer { position: fixed; top: 0; left: 0; right: 0; background-color: var(--tg-theme-bg-color); padding: 10px; z-index: 1000; border-bottom: 1px solid var(--tg-theme-hint-color); display: flex; align-items: center;}
        .form-check-input:checked { background-color: var(--tg-theme-button-color); border-color: var(--tg-theme-button-color); }
        .late-submission { color: orange; font-weight: bold; }
        .missing-submission { color: red; }
    </style>
</head>
<body>

<div class="container-fluid">

    <div id="groupSelectorContainer">
        <label for="groupSelector" class="form-label me-2 mb-0">Группа:</label>
        <select id="groupSelector" class="form-select form-select-sm" onchange="handleGroupChange(this.value)">
            <option value="">Загрузка...</option>
        </select>
    </div>

    <ul class="nav nav-pills mb-3" id="adminTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">Посещ.</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button" role="tab">Задания</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="submissions-tab" data-bs-toggle="tab" data-bs-target="#submissions" type="button" role="tab">Оценки</button>
        </li>
         <li class="nav-item" role="presentation">
            <button class="nav-link" id="qa-tab" data-bs-toggle="tab" data-bs-target="#qa" type="button" role="tab">Q&A</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Студенты</button>
        </li>
         <li class="nav-item" role="presentation">
            <button class="nav-link" id="approvals-tab" data-bs-toggle="tab" data-bs-target="#approvals" type="button" role="tab">Заявки <span id="approvalBadge" class="badge bg-danger ms-1" style="display: none;"></span></button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab">Группы</button>
        </li>
    </ul>

    <div class="tab-content" id="adminTabContent">

        <div class="tab-pane fade show active" id="attendance" role="tabpanel">
            <h2>Посещаемость (<span class="current-group-name"></span>)</h2>
            <div class="mb-3 d-flex align-items-center">
                 <label for="attendanceDate" class="form-label me-2 mb-0">Дата:</label>
                 <input type="date" id="attendanceDate" class="form-control form-control-sm w-auto me-2">
                 <button class="btn btn-sm btn-secondary" onclick="loadAttendance()">Загрузить</button>
            </div>
            <div id="attendanceList">
                <div class="loading">Выберите группу и дату.</div>
            </div>
             <button class="btn btn-primary mt-2" id="saveAttendanceBtn" style="display: none;" onclick="saveAttendance()">Сохранить отметки</button>
        </div>

        <div class="tab-pane fade" id="assignments" role="tabpanel">
            <h2>Задания для группы <span class="current-group-name"></span></h2>
             <div class="mb-3 border p-2 rounded">
                <h5>Новое задание</h5>
                <input type="text" id="assignmentTitle" class="form-control mb-2" placeholder="Название задания">
                <textarea id="assignmentDescription" class="form-control mb-2" rows="3" placeholder="Описание задания"></textarea>
                <label for="assignmentFile" class="form-label">Файл (опционально, 1 шт.):</label>
                <input type="file" id="assignmentFile" class="form-control mb-2">
                <label for="assignmentDueDate" class="form-label">Срок сдачи (опционально):</label>
                <input type="datetime-local" id="assignmentDueDate" class="form-control mb-2">
                <button class="btn btn-primary" onclick="sendAssignment()">Отправить задание группе</button>
            </div>
            <hr>
             <h5>Существующие задания для группы <span class="current-group-name"></span></h5>
             <div id="assignmentsList">
                 <div class="loading">Загрузка заданий...</div>
             </div>
        </div>

        <div class="tab-pane fade" id="submissions" role="tabpanel">
            <h2>Оценки и Статистика (Группа <span class="current-group-name"></span>)</h2>
            <div class="mb-3">
                <label for="submissionAssignmentSelect" class="form-label">Выберите задание:</label>
                <select id="submissionAssignmentSelect" class="form-select mb-2" onchange="loadSubmissionsForAssignment(this.value)">
                    <option value="">Выберите задание...</option>
                </select>
            </div>
             <div id="submissionControls" class="mb-3" style="display: none;">
                 <button class="btn btn-sm btn-warning" onclick="toggleAcceptSubmissions()">Закрыть/Открыть прием работ</button>
                 <span id="acceptingStatus" class="ms-2"></span>
             </div>
             <div id="submissionStats" class="mb-3"></div>
            <div id="submissionsList"></div>
        </div>

         <div class="tab-pane fade" id="qa" role="tabpanel">
             <h2>Вопросы от студентов</h2>
             <div class="mb-2">
                 <button class="btn btn-sm btn-secondary" onclick="loadQuestions(false)">Неотвеченные</button>
                 <button class="btn btn-sm btn-secondary" onclick="loadQuestions(true)">Все</button>
             </div>
             <div id="questionsList">
                 <div class="loading">Загрузка вопросов...</div>
             </div>
         </div>

        <div class="tab-pane fade" id="users" role="tabpanel">
            <h2>Студенты группы <span class="current-group-name"></span></h2>
            <div id="studentsListGroup" class="list-group">
                <div class="loading">Загрузка студентов...</div>
            </div>
        </div>

        <div class="tab-pane fade" id="approvals" role="tabpanel">
             <h2>Ожидают подтверждения</h2>
             <div id="pendingUsersList" class="list-group mb-4"></div>
            <hr>
            <h2>Запросы на смену группы/имени</h2>
             <div id="pendingGroupChangesList" class="list-group mb-2"></div>
             <div id="pendingNameChangesList" class="list-group"></div>
        </div>

        <div class="tab-pane fade" id="groups" role="tabpanel">
            <h2>Управление группами</h2>
            <div class="input-group mb-3">
                <input type="text" id="newGroupName" class="form-control" placeholder="Название новой группы">
                <button class="btn btn-primary" onclick="addGroup()">Добавить</button>
            </div>
            <div id="groupsList" class="list-group"></div>
        </div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const tg = window.Telegram.WebApp;
    const initData = tg.initDataUnsafe || {};
    const currentUser = initData.user || {};
    const API_BASE_URL = '/api';

    let currentGroupId = localStorage.getItem('currentGroupId') || null;
    let studentsForAttendance = [];
    let studentsForGroupManagement = [];
    let assignmentsForGroup = [];
    let submissionsForAssignment = [];
    let questionsData = [];
    let currentAssignmentAccepting = true;

    async function apiRequest(endpoint, method = 'GET', body = null, isFormData = false) {
        tg.MainButton.showProgress();
        try {
            const headers = { 'Telegram-Init-Data': tg.initData };
            if (!isFormData && body) {
                headers['Content-Type'] = 'application/json';
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: method, headers: headers,
                body: isFormData ? body : (body ? JSON.stringify(body) : null),
            });

            if (!response.ok) {
                let errorData = { detail: response.statusText };
                try { errorData = await response.json(); } catch (e) {}
                throw new Error(errorData.detail || `HTTP error ${response.status}`);
            }
            return response.status === 204 ? null : await response.json();
        } catch (error) {
            console.error('API Error:', method, endpoint, error);
            tg.showAlert(`Ошибка API: ${error.message || 'Неизвестная ошибка'}`);
            return null;
        } finally {
            tg.MainButton.hideProgress();
        }
    }

    function updateCurrentGroupName(groupId, groups) {
         const groupName = groupId ? groups.find(g => g.group_id == groupId)?.name || '?' : 'Не выбрана';
         document.querySelectorAll('.current-group-name').forEach(el => el.textContent = groupName);
     }

    async function loadInitialData() {
        const groups = await apiRequest('/groups');
        if (!groups) return;

        const groupSelector = document.getElementById('groupSelector');
        const currentSelectedValue = groupSelector.value;
        groupSelector.innerHTML = '<option value="">Выберите группу...</option>';
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.group_id;
            option.textContent = group.name;
            if (currentGroupId && group.group_id == currentGroupId) {
                 option.selected = true;
            } else if (!currentGroupId && currentSelectedValue && group.group_id == currentSelectedValue) {
                 option.selected = true; // Keep selection if currentGroupId was nullified
                 currentGroupId = currentSelectedValue;
                 localStorage.setItem('currentGroupId', currentGroupId);
            }
            groupSelector.appendChild(option);
        });

        if (!groupSelector.value && currentGroupId) {
             currentGroupId = null; // Group might have been deleted
             localStorage.removeItem('currentGroupId');
        } else if (groupSelector.value) {
            currentGroupId = groupSelector.value; // Ensure currentGroupId is set if selected
             localStorage.setItem('currentGroupId', currentGroupId);
        }


        updateCurrentGroupName(currentGroupId, groups);
        loadGroupsList(groups);
        loadApprovals();

        const activeTab = document.querySelector('#adminTab .nav-link.active');
        if (activeTab) {
             handleTabChange(activeTab.getAttribute('data-bs-target'));
        }
     }

     function handleGroupChange(groupId) {
         currentGroupId = groupId || null;
         if (currentGroupId) localStorage.setItem('currentGroupId', currentGroupId);
         else localStorage.removeItem('currentGroupId');
         loadInitialData();
     }

    async function loadStudentsForGroup(groupId) {
         const listDiv = document.getElementById('studentsListGroup');
         if (!groupId) { listDiv.innerHTML = '<div class="list-group-item">Группа не выбрана.</div>'; return; }
         listDiv.innerHTML = '<div class="loading">Загрузка студентов...</div>';
         studentsForGroupManagement = await apiRequest(`/users?role=student&group_id=${groupId}`);
         if (studentsForGroupManagement && studentsForGroupManagement.length > 0) {
             listDiv.innerHTML = studentsForGroupManagement.map(s => `
                 <div class="list-group-item d-flex justify-content-between align-items-center">
                     <span>${s.last_name} ${s.first_name}</span>
                     <button class="btn btn-sm btn-danger" onclick="removeStudentFromGroup(${s.user_id}, '${s.last_name} ${s.first_name}')">Удалить из группы</button>
                 </div>`).join('');
         } else if (studentsForGroupManagement) {
             listDiv.innerHTML = '<div class="list-group-item">Студентов нет.</div>';
         } else {
             listDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка загрузки.</div>';
         }
     }

     async function removeStudentFromGroup(userId, studentName) {
         tg.showConfirm(`Удалить ${studentName} из группы?`, async (confirmed) => {
             if (confirmed) {
                 if (await apiRequest(`/users/${userId}/group`, 'PATCH', { group_id: null })) {
                     loadStudentsForGroup(currentGroupId);
                 }
             }
         });
     }

     async function loadAttendance() {
         const date = document.getElementById('attendanceDate').value;
         const listDiv = document.getElementById('attendanceList');
         const saveBtn = document.getElementById('saveAttendanceBtn');
         saveBtn.style.display = 'none';

         if (!currentGroupId || !date) { listDiv.innerHTML = '<div class="list-group-item">Выберите группу и дату.</div>'; return; }
         listDiv.innerHTML = '<div class="loading">Загрузка...</div>';

         const [students, attendanceData] = await Promise.all([
             apiRequest(`/users?role=student&group_id=${currentGroupId}&approved=true`),
             apiRequest(`/attendance?group_id=${currentGroupId}&date=${date}`)
         ]);

         if (!students) { listDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка студентов.</div>'; return; }

         studentsForAttendance = students;
         const attendanceMap = new Map(attendanceData?.map(att => [att.student_id, att.is_present]) || []);

         if (students.length > 0) {
             listDiv.innerHTML = students.map(s => {
                 const isPresent = attendanceMap.get(s.user_id) ?? true;
                 return `
                     <div class="list-group-item d-flex justify-content-between align-items-center student-attendance-row">
                         <span>${s.last_name} ${s.first_name}</span>
                         <div class="form-check form-switch">
                           <input class="form-check-input" type="checkbox" role="switch" id="att-${s.user_id}" data-studentid="${s.user_id}" ${isPresent ? 'checked' : ''}>
                           <label class="form-check-label" for="att-${s.user_id}">${isPresent ? 'Да' : 'Нет'}</label>
                         </div>
                     </div>`;
             }).join('');
             saveBtn.style.display = 'block';
             listDiv.querySelectorAll('.form-check-input').forEach(input => {
                 input.addEventListener('change', (e) => e.target.nextElementSibling.textContent = e.target.checked ? 'Да' : 'Нет');
             });
         } else { listDiv.innerHTML = '<div class="list-group-item">Студентов нет.</div>'; }
     }

     async function saveAttendance() {
         const date = document.getElementById('attendanceDate').value;
         if (!currentGroupId || !date) return;
         const payload = { group_id: parseInt(currentGroupId), date: date, attendance: [] };
         document.querySelectorAll('#attendanceList .form-check-input').forEach(input => {
             payload.attendance.push({ student_id: parseInt(input.dataset.studentid), is_present: input.checked });
         });
         if (await apiRequest('/attendance', 'POST', payload)) {
             tg.showAlert('Посещаемость сохранена.');
             loadAttendance();
         }
     }

     async function loadAssignmentsForGroup(groupId) {
         const assignmentSelect = document.getElementById('submissionAssignmentSelect');
         const assignmentsListDiv = document.getElementById('assignmentsList');
         assignmentSelect.innerHTML = '<option value="">Загрузка...</option>';
         assignmentsListDiv.innerHTML = '<div class="loading">Загрузка...</div>';
         document.getElementById('submissionControls').style.display = 'none';

         if (!groupId) {
              assignmentSelect.innerHTML = '<option value="">Группа?</option>';
              assignmentsListDiv.innerHTML = '<div class="list-group-item">Группа?</div>';
              assignmentsForGroup = []; return;
         }

         assignmentsForGroup = await apiRequest(`/assignments?group_id=${groupId}`);
         if (assignmentsForGroup) {
             const optionsHtml = '<option value="">Выберите задание...</option>' + assignmentsForGroup.map(a => `<option value="${a.assignment_id}">${a.title}</option>`).join('');
             assignmentSelect.innerHTML = optionsHtml;
             assignmentsListDiv.innerHTML = assignmentsForGroup.length > 0
                 ? assignmentsForGroup.map(a => `
                     <div class="list-group-item">
                         <strong>${a.title}</strong> (ID: ${a.assignment_id})
                         ${a.due_date ? `<br><small>Срок: ${new Date(a.due_date).toLocaleString()}</small>` : ''}
                         <br><small>Прием работ: ${a.accepting_submissions ? 'Открыт ✅' : 'Закрыт ❌'}</small>
                     </div>`).join('')
                 : '<div class="list-group-item">Заданий нет.</div>';
         } else {
              assignmentSelect.innerHTML = '<option value="">Ошибка</option>';
              assignmentsListDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка.</div>';
         }
      }

      async function sendAssignment() {
         if (!currentGroupId) { tg.showAlert('Выберите группу.'); return; }
         const title = document.getElementById('assignmentTitle').value.trim();
         if (!title) { tg.showAlert('Введите название.'); return; }
         const description = document.getElementById('assignmentDescription').value.trim();
         const fileInput = document.getElementById('assignmentFile');
         const file = fileInput.files[0];
         const dueDate = document.getElementById('assignmentDueDate').value ? new Date(document.getElementById('assignmentDueDate').value).toISOString() : null;

         tg.MainButton.showProgress();
         let fileInfo = null;
         if (file) {
             const formData = new FormData(); formData.append('file', file);
             fileInfo = await apiRequest('/upload_file', 'POST', formData, true);
             if (!fileInfo || !fileInfo.file_id) { tg.MainButton.hideProgress(); return; }
         }

         const payload = {
             group_id: parseInt(currentGroupId), title: title, description: description || null, due_date: dueDate,
             file_id: fileInfo?.file_id, file_type: fileInfo?.file_type
         };

         const result = await apiRequest('/assignments/send', 'POST', payload);
         tg.MainButton.hideProgress();
         if (result && result.assignment_id) {
             document.getElementById('assignmentTitle').value = '';
             document.getElementById('assignmentDescription').value = '';
             fileInput.value = ''; document.getElementById('assignmentDueDate').value = '';
             tg.showAlert('Задание отправлено.');
             // Уведомляем бота для рассылки
             tg.sendData(JSON.stringify({
                 action: 'send_assignment_to_group',
                 assignment_id: result.assignment_id,
                 group_id: payload.group_id, title: payload.title, description: payload.description,
                 due_date: payload.due_date, file_id: payload.file_id, file_type: payload.file_type
             }));
             loadAssignmentsForGroup(currentGroupId);
         } else { tg.showAlert('Не удалось отправить.'); }
     }

     async function toggleAcceptSubmissions() {
         const assignmentId = document.getElementById('submissionAssignmentSelect').value;
         if (!assignmentId) return;
         const newState = !currentAssignmentAccepting;
         const result = await apiRequest(`/assignments/${assignmentId}/toggle_submission`, 'POST', { accept: newState });
         if (result) {
             currentAssignmentAccepting = newState;
             document.getElementById('acceptingStatus').textContent = newState ? 'Прием открыт ✅' : 'Прием закрыт ❌';
             tg.showAlert(`Прием работ ${newState ? 'открыт' : 'закрыт'}.`);
             loadAssignmentsForGroup(currentGroupId); // Update list view
         }
     }

     async function loadSubmissionsForAssignment(assignmentId) {
         const statsDiv = document.getElementById('submissionStats');
         const listDiv = document.getElementById('submissionsList');
         const controlsDiv = document.getElementById('submissionControls');
         controlsDiv.style.display = 'none';

         if (!assignmentId) { statsDiv.innerHTML = ''; listDiv.innerHTML = ''; submissionsForAssignment = []; return; }

         statsDiv.innerHTML = '<div class="loading">Загрузка...</div>';
         listDiv.innerHTML = '<div class="loading">Загрузка...</div>';

         const [students, submissions, assignmentInfo] = await Promise.all([
             apiRequest(`/users?role=student&group_id=${currentGroupId}&approved=true`),
             apiRequest(`/assignments/${assignmentId}/submissions`),
             apiRequest(`/assignments/${assignmentId}`) // Get assignment info for deadline and status
         ]);

         if (!students || !assignmentInfo) {
              listDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка загрузки.</div>';
              statsDiv.innerHTML = ''; return;
         }
         currentAssignmentAccepting = assignmentInfo.accepting_submissions;
         controlsDiv.style.display = 'block';
         document.getElementById('acceptingStatus').textContent = currentAssignmentAccepting ? 'Прием открыт ✅' : 'Прием закрыт ❌';


         submissionsForAssignment = submissions || [];
         const submissionMap = new Map(submissionsForAssignment.map(sub => [sub.student_id, sub]));
         let submittedCount = 0, gradedCount = 0, lateCount = 0;

         if (students.length > 0) {
             listDiv.innerHTML = students.map(student => {
                 const sub = submissionMap.get(student.user_id);
                 let statusHtml = '<span class="missing-submission">Не сдано</span>';
                 let gradeHtml = '', fileHtml = '', timeHtml = '';

                 if (sub) {
                     submittedCount++;
                     const isLate = sub.is_late;
                     if (isLate) lateCount++;
                     statusHtml = `<span class="${isLate ? 'late-submission' : 'text-warning'}">Сдано${isLate ? ' (опоздание)' : ''}</span>`;
                     fileHtml = `<button class="btn btn-sm btn-outline-secondary me-2" onclick="requestFileFromBot('${sub.file_id}', ${sub.submission_id})">Файл</button>`;
                     timeHtml = `<small>${new Date(sub.submission_date).toLocaleString()}</small>`;

                     let score1Val = '', score2Val = '';
                     if (sub.grade !== null) {
                         gradedCount++;
                         statusHtml = `<span class="text-success">Оценка: ${sub.grade}</span>`;
                         // Example parsing back score1, score2 - ASSUMES grade = score1 + score2
                         score1Val = Math.min(10, sub.grade); // Placeholder logic
                         score2Val = Math.max(0, sub.grade - 10); // Placeholder logic
                     }

                     gradeHtml = `
                         <div class="mt-2">
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text">Балл 1</span>
                                <input type="number" id="score1-${sub.submission_id}" class="form-control" min="0" max="10" value="${score1Val}">
                            </div>
                             <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text">Балл 2</span>
                                <input type="number" id="score2-${sub.submission_id}" class="form-control" min="0" max="10" value="${score2Val}">
                            </div>
                             <textarea id="comment-${sub.submission_id}" class="form-control form-control-sm mb-1" placeholder="Комментарий">${sub.teacher_comment || ''}</textarea>
                             <button class="btn btn-sm btn-primary" onclick="gradeSubmission(${sub.submission_id})">Оценить</button>
                         </div>`;
                 }

                 return `
                     <div class="list-group-item mb-2">
                         <div class="d-flex justify-content-between align-items-center flex-wrap">
                             <span class="me-2">${student.last_name} ${student.first_name}</span>
                             <div class="d-flex align-items-center">
                                ${fileHtml}
                                ${statusHtml}
                                <span class="ms-2">${timeHtml}</span>
                             </div>
                         </div>
                         ${gradeHtml}
                     </div>`;
             }).join('');
         } else { listDiv.innerHTML = '<div class="list-group-item">Студентов нет.</div>'; }

          statsDiv.innerHTML = `
              <div>Всего: <strong>${students.length}</strong> | Сдано: <strong>${submittedCount}</strong> | Не сдано: <strong class="missing-submission">${students.length - submittedCount}</strong></div>
              <div>Оценено: <strong>${gradedCount}</strong> | Опоздания: <strong class="late-submission">${lateCount}</strong></div>
          `;
     }

     function requestFileFromBot(fileId, submissionId) {
         tg.sendData(JSON.stringify({ action: 'get_submission_file', file_id: fileId, submission_id: submissionId }));
     }

     async function gradeSubmission(submissionId) {
         const s1 = document.getElementById(`score1-${submissionId}`).value;
         const s2 = document.getElementById(`score2-${submissionId}`).value;
         const comment = document.getElementById(`comment-${submissionId}`).value.trim();
         const score1 = s1 === '' ? null : parseInt(s1);
         const score2 = s2 === '' ? null : parseInt(s2);

         if ((score1 !== null && (score1 < 0 || score1 > 10)) || (score2 !== null && (score2 < 0 || score2 > 10))) {
             tg.showAlert('Баллы 0-10.'); return;
         }
         const finalGrade = (score1 !== null && score2 !== null) ? score1 + score2 : null;
         const payload = { grade: finalGrade, comment: comment || null };

         if (await apiRequest(`/submissions/${submissionId}/grade`, 'PATCH', payload)) {
             loadSubmissionsForAssignment(document.getElementById('submissionAssignmentSelect').value);
         }
     }

     async function loadQuestions(showAnswered = false) {
         const listDiv = document.getElementById('questionsList');
         listDiv.innerHTML = '<div class="loading">Загрузка...</div>';
         const endpoint = showAnswered ? '/questions?answered=all' : '/questions?answered=false';
         questionsData = await apiRequest(endpoint);

         if (questionsData && questionsData.length > 0) {
             listDiv.innerHTML = questionsData.map(q => `
                 <div class="list-group-item mb-2">
                     <p><strong>${q.student_last_name || ''} ${q.student_first_name || '?'}</strong> (${q.group_name || '?'})</p>
                     <p><small>${new Date(q.asked_at).toLocaleString()}</small></p>
                     <p>${q.question_text}</p>
                     ${q.answer_text
                         ? `<hr><p><strong>Ответ (${q.answerer_name || '?'}):</strong> ${q.answer_text} <br><small>${new Date(q.answered_at).toLocaleString()}</small></p>`
                         : `<hr><textarea id="answer-${q.question_id}" class="form-control form-control-sm mb-1" rows="2"></textarea>
                            <button class="btn btn-sm btn-primary" onclick="answerQuestion(${q.question_id}, ${q.student_telegram_id}, '${btoa(encodeURIComponent(q.question_text))}')">Ответить</button>`
                     }
                 </div>`).join('');
         } else if (questionsData) {
              listDiv.innerHTML = `<div class="list-group-item">${showAnswered ? 'Вопросов нет.' : 'Нет неотвеч.'}</div>`;
         } else { listDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка.</div>'; }
     }

     async function answerQuestion(questionId, studentTelegramId, questionTextBase64) {
         const answerText = document.getElementById(`answer-${questionId}`).value.trim();
         if (!answerText) return;

         const result = await apiRequest(`/questions/${questionId}/answer`, 'POST', { answer_text: answerText });
         if (result) {
             tg.showAlert('Ответ отправлен.');
             // Notify bot to send message to student
             tg.sendData(JSON.stringify({
                 action: 'notify_answer', student_telegram_id: studentTelegramId,
                 question_text: decodeURIComponent(atob(questionTextBase64)), answer_text: answerText
             }));
             loadQuestions(false);
         }
     }

     async function loadGroupsList(groups = null) {
         const listDiv = document.getElementById('groupsList');
         if (!groups) { listDiv.innerHTML = '<div class="loading">Загрузка...</div>'; groups = await apiRequest('/groups'); }
         if (groups) {
             listDiv.innerHTML = groups.length > 0
                 ? groups.map(g => `<div class="list-group-item d-flex justify-content-between align-items-center"><span>${g.name}</span><button class="btn btn-sm btn-danger" onclick="deleteGroup(${g.group_id}, '${g.name}')">X</button></div>`).join('')
                 : '<div class="list-group-item">Групп нет.</div>';
         } else { listDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка.</div>'; }
     }

     async function addGroup() {
        const nameInput = document.getElementById('newGroupName');
        const name = nameInput.value.trim();
        if (!name) return;
        if (await apiRequest('/groups', 'POST', { name: name })) {
            nameInput.value = ''; loadInitialData();
        }
     }

     async function deleteGroup(groupId, groupName) {
        tg.showConfirm(`Удалить группу "${groupName}"?`, async (ok) => {
             if (ok && await apiRequest(`/groups/${groupId}`, 'DELETE')) {
                 if (currentGroupId == groupId) { currentGroupId = null; localStorage.removeItem('currentGroupId'); }
                 loadInitialData();
            }
        });
     }

     async function loadApprovals() {
         const pendingUsersDiv = document.getElementById('pendingUsersList');
         const pendingChangesDiv = document.getElementById('pendingGroupChangesList');
         const pendingNameChangesDiv = document.getElementById('pendingNameChangesList');
         pendingUsersDiv.innerHTML = '<div class="loading">...</div>';
         pendingChangesDiv.innerHTML = '<div class="loading">...</div>';
         pendingNameChangesDiv.innerHTML = '<div class="loading">...</div>';

         const [pendingUsers, pendingGroups, pendingNames] = await Promise.all([
              apiRequest('/users?approved=false'),
              apiRequest('/group_changes/pending'),
              apiRequest('/name_changes/pending') // Need this API endpoint
         ]);

         let totalPending = 0;

         if (pendingUsers) {
             totalPending += pendingUsers.length;
             pendingUsersDiv.innerHTML = pendingUsers.length > 0 ? pendingUsers.map(u => `
                 <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                     <div class="me-2 mb-1"><strong>${u.first_name} ${u.last_name}</strong><br><small>${u.group_name || 'Без гр.'}</small></div>
                     <div><button class="btn btn-sm btn-success me-1" onclick="approveUser(${u.user_id}, true, 'student')">Стд.</button><button class="btn btn-sm btn-primary me-1" onclick="approveUser(${u.user_id}, true, 'teacher')">Преп.</button><button class="btn btn-sm btn-danger" onclick="rejectUser(${u.user_id})">X</button></div>
                 </div>`).join('') : '<div class="list-group-item">Новых нет.</div>';
         } else pendingUsersDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка.</div>';

         if (pendingGroups) {
              totalPending += pendingGroups.length;
              pendingChangesDiv.innerHTML = pendingGroups.length > 0 ? pendingGroups.map(c => `
                  <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                     <div class="me-2 mb-1"><strong>${c.first_name} ${c.last_name}</strong><br><small>${c.current_group_name || 'Без гр.'} → ${c.pending_group_name}</small></div>
                     <div><button class="btn btn-sm btn-success me-1" onclick="approveGroupChange(${c.user_id})">Да</button><button class="btn btn-sm btn-danger" onclick="rejectGroupChange(${c.user_id})">Нет</button></div>
                 </div>`).join('') : '<div class="list-group-item">Запросов смены группы нет.</div>';
         } else pendingChangesDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка.</div>';

         if (pendingNames) {
              totalPending += pendingNames.length;
              pendingNameChangesDiv.innerHTML = pendingNames.length > 0 ? pendingNames.map(n => `
                  <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                     <div class="me-2 mb-1"><strong>${n.current_first_name} ${n.current_last_name}</strong><br><small>→ ${n.pending_first_name} ${n.pending_last_name}</small></div>
                     <div><button class="btn btn-sm btn-success me-1" onclick="approveNameChange(${n.user_id})">Да</button><button class="btn btn-sm btn-danger" onclick="rejectNameChange(${n.user_id})">Нет</button></div>
                 </div>`).join('') : '<div class="list-group-item">Запросов смены имени нет.</div>';
         } else pendingNameChangesDiv.innerHTML = '<div class="list-group-item text-danger">Ошибка.</div>';


         const badge = document.getElementById('approvalBadge');
         if (totalPending > 0) { badge.textContent = totalPending; badge.style.display = 'inline-block'; }
         else { badge.style.display = 'none'; }
     }

     async function approveUser(userId, status, role = null) {
         const approveResult = await apiRequest(`/users/${userId}/approve`, 'PATCH', { approved: status });
         let roleResult = true;
         if (approveResult && role) { roleResult = await apiRequest(`/users/${userId}/role`, 'PATCH', { role: role }); }
         if (approveResult && roleResult) { loadApprovals(); tg.showAlert(`Статус изменен.`); }
         else { tg.showAlert('Ошибка.'); }
     }
     async function rejectUser(userId) { await approveUser(userId, false); }
     async function approveGroupChange(userId) { if (await apiRequest(`/group_changes/${userId}/approve`, 'POST')) loadApprovals(); }
     async function rejectGroupChange(userId) { if (await apiRequest(`/group_changes/${userId}/reject`, 'POST')) loadApprovals(); }
     async function approveNameChange(userId) { if (await apiRequest(`/name_changes/${userId}/approve`, 'POST')) loadApprovals(); }
     async function rejectNameChange(userId) { if (await apiRequest(`/name_changes/${userId}/reject`, 'POST')) loadApprovals(); }

     function handleTabChange(targetId) {
         const requiresGroup = ['#attendance', '#assignments', '#submissions', '#users'];
         if (requiresGroup.includes(targetId) && !currentGroupId) {
             document.querySelector(targetId).innerHTML = '<div class="alert alert-warning">Выберите группу.</div>'; return;
         }
         switch(targetId) {
             case '#attendance': loadAttendance(); break;
             case '#assignments': loadAssignmentsForGroup(currentGroupId); break;
             case '#submissions': loadAssignmentsForGroup(currentGroupId); break; // Need assignments for select
             case '#qa': loadQuestions(false); break;
             case '#users': loadStudentsForGroup(currentGroupId); break;
             case '#approvals': loadApprovals(); break;
             case '#groups': loadGroupsList(); break;
         }
     }

    document.addEventListener('DOMContentLoaded', () => {
        tg.ready(); tg.expand();
        tg.setHeaderColor(tg.themeParams.secondary_bg_color || '#efefef');
        const styles = document.documentElement.style;
        styles.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        styles.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        styles.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
        styles.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#007bff');
        styles.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#007bff');
        styles.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        styles.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f8f9fa');

        document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        loadInitialData();
        document.getElementById('adminTab')?.addEventListener('shown.bs.tab', e => handleTabChange(e.target.getAttribute('data-bs-target')));
    });
</script>

</body>
</html>